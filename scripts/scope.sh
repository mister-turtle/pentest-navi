#!/usr/bin/env bash

function _urls2dns
{
    dirs_input="${1:-./scope_url}"
    dirs_output="${2:-./scope_dns}"

    echo -e "${BLUE}Pentest-Navi - URLs to DNS${NC}"

    [[ ! -e "${dirs_input}" ]] && { echo "Input file ${dirs_input} doesnt exist"; exit 1; }

    while read -r line
    do
        dns="$( echo "${line}" | python -c 'from urllib.parse import urlparse;import sys;print(urlparse(sys.stdin.read()).netloc)' )"
        [[ -z "${dns}" ]] && { echo -e "${line} ${RED}>> Failed${NC}"; continue; }
        echo -e "${line} ${GREEN}>>${NC} ${dns}"
        echo "${dns}" >> "${dirs_output}"
    done < "${dirs_input}"
}

function _dns2ip
{
    dirs_input="${1:-./scope_dns}"
    dirs_output="${2:-./scope}"
    dirs_map="${3:-/scope_map}"

    echo -e "${BLUE}Pentest-Navi - DNS to IP${NC}"
    while read -r host
    do
        digout="$( dig +short "${host}" )"
        ret=$?
        [[ $ret -ne 0 ]] && { echo -e "${host} ${RED}>> Failed (dig exit: $ret)${NC}"; continue; }
        [[ -z "${digout}" ]] && { echo -e "${host} ${RED}>> Failed (dig output empty)${NC}"; continue; }

        while read -r record
        do
            echo -e "${host} ${GREEN}>>${NC} ${record}"
            echo "${record}" >> "${dirs_output}"
            echo "${host}:${record}" >> "${dirs_map}"
        done <<< "${digout}"

    done < "${dirs_input}"

    sort -u "${dirs_output}" -o "${dirs_output}"
    sort -u "${dirs_map}" -o "${dirs_map}"
}

function _urls2all
{
    dirs_urls="${1:-./scope_url}"
    dirs_dns="${2:-./scope_dns}"
    dirs_map="${3:-./scope_map}"
    dirs_ips="${4:-./scope}"

    _urls2dns "${dirs_urls}" "${dirs_dns}"
    echo ""
    _dns2ip "${dirs_dns}" "${dirs_ips}" "${dirs_map}"
}

function _whois
{
    dirs_input="${1:-./scope}"
    dirs_output="${2:-./whois/}"
    delay="${3:-3}"

    echo -e "${BLUE}Pentest-Navi - whois (delay: ${delay}s)${NC}"
    echo -e "Output directory: ${dirs_output}"

    slept="true"

    [[ ! -d "${dirs_output}" ]] && mkdir -p "${dirs_output}"

    while read -r host
    do
        [[ -z "${host}" ]] && continue

        ## sleep to not hammer whois dbs
        [[ "${slept}" == "false" ]] && sleep 3

        out="${dirs_output}whois-${host}.txt"

        data="$( whois "${host}" )"
        ret=$?
        [[ $ret -ne 0 ]] && { echo -e "${RED}${host} failed (whois exit: $ret)${NC}"; continue; }

        orgname="$(echo "${data}" | grep -y "orgname" | awk '{$1=$1};1')"
        netrange="$(echo "${data}" | grep -y "netrange" | awk '{$1=$1};1')"
        
        echo -en "${GREEN}${host}${NC} "
        [[ -n "${netrange}" ]] && echo -n "(${netrange}) "
        [[ -n "${orgname}"  ]] && echo -n "(${orgname}) "
        echo ""
        
        echo "${data}" > "${out}"
        slept="false"

    done < "${dirs_input}"
}